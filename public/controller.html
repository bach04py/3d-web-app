<script>
  const socket = io();
  socket.emit("identify", "controller");

  let gamma = 0, beta = 90;
  const TILT_THRESHOLD = 10;
  const sendInterval = 1000 / 60; // 60 FPS ~ 16.67ms
  let lastSendTime = 0;

  function handleOrientation(event) {
    gamma = event.gamma;
    beta = event.beta;
  }

  function sendMotionCommand() {
    const now = performance.now();
    if (now - lastSendTime < sendInterval) {
      requestAnimationFrame(sendMotionCommand);
      return;
    }

    if (gamma > TILT_THRESHOLD) {
      socket.emit("move", "right");
    } else if (gamma < -TILT_THRESHOLD) {
      socket.emit("move", "left");
    }

    if (beta > 90 + TILT_THRESHOLD) {
      socket.emit("move", "backward");
    } else if (beta < 90 - TILT_THRESHOLD) {
      socket.emit("move", "forward");
    }

    lastSendTime = now;
    requestAnimationFrame(sendMotionCommand);
  }

  function initMotion() {
    if (typeof DeviceOrientationEvent?.requestPermission === "function") {
      DeviceOrientationEvent.requestPermission().then(response => {
        if (response === "granted") {
          window.addEventListener("deviceorientation", handleOrientation);
          document.getElementById("startBtn").style.display = "none";
          socket.emit("mobile-connected");
          requestAnimationFrame(sendMotionCommand);
        }
      });
    } else {
      window.addEventListener("deviceorientation", handleOrientation);
      document.getElementById("startBtn").style.display = "none";
      socket.emit("mobile-connected");
      requestAnimationFrame(sendMotionCommand);
    }
  }
</script>

