<script>
  const socket = io();
  socket.emit("identify", "controller");

  // Gửi lệnh thủ công vẫn giữ nguyên
  function sendMove(direction) {
    socket.emit("move", direction);
  }

  // Ngưỡng và thời gian cooldown để tránh gửi lệnh liên tục
  const TILT_THRESHOLD = 15; // độ nghiêng tối thiểu để kích hoạt
  const COOLDOWN = 500; // ms
  let lastSent = { leftRight: 0, upDown: 0 };

  window.addEventListener("deviceorientation", (event) => {
    const gamma = event.gamma; // trái-phải (-90 to 90)
    const beta = event.beta;   // trước-sau (-180 to 180)

    const now = Date.now();

    if (gamma > TILT_THRESHOLD && now - lastSent.leftRight > COOLDOWN) {
      socket.emit("move", "right");
      lastSent.leftRight = now;
    } else if (gamma < -TILT_THRESHOLD && now - lastSent.leftRight > COOLDOWN) {
      socket.emit("move", "left");
      lastSent.leftRight = now;
    }

    if (beta > 90 + TILT_THRESHOLD && now - lastSent.upDown > COOLDOWN) {
      socket.emit("move", "backward");
      lastSent.upDown = now;
    } else if (beta < 90 - TILT_THRESHOLD && now - lastSent.upDown > COOLDOWN) {
      socket.emit("move", "forward");
      lastSent.upDown = now;
    }
  });

  // Cho phép người dùng cấp quyền truy cập sensor (đặc biệt trên iOS)
  if (
    typeof DeviceOrientationEvent !== "undefined" &&
    typeof DeviceOrientationEvent.requestPermission === "function"
  ) {
    document.body.addEventListener("click", () => {
      DeviceOrientationEvent.requestPermission().then((response) => {
        if (response === "granted") {
          console.log("Permission granted for motion.");
        }
      });
    });
  }
</script>

